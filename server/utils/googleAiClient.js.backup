const { GoogleGenerativeAI } = require('@google/generative-ai');

const initializeAiClients = () => {
  const apiKey = process.env.GOOGLE_API_KEY;
  if (!apiKey) {
    You are an expert life coach and psychologist.Analyze the following user data to provide a deep, insightful character analysis and a highly personalized, actionable roadmap.

    USER CONTEXT:
    Age: ${ context.age }
    Job / Industry: ${ context.job }
    Location: ${ context.location }
    Economic Situation: ${ context.economy }
    Stated Goal: ${ context.goal }

    QUESTIONNAIRE ANSWERS(Scale 1 - 5, 1 = Strongly Disagree, 5 = Strongly Agree):
    ${ JSON.stringify(answers, null, 2) }

    TASKS:
    1. ** Character Analysis:** Based on the questionnaire and context, identify 3 - 5 key personality archetypes or traits.Write a compelling narrative(200 - 300 words) that speaks directly to the user("You are...").Be encouraging but realistic.
    2. ** Personalized Suggestions:** Provide 3 - 5 concrete, actionable habits or changes the user can make immediately to align with their goal(${ context.goal }).
    3. ** Strategic Roadmap:** Create a 5 - step roadmap tailored to their goal.Each step should have:
    - A clear, action - oriented title
      - A detailed description of what to do and why
        - A creative, descriptive prompt for an AI image generator(describe the scene, mood, style â€“ be vivid!)

    RESPONSE FORMAT(JSON only, no markdown):
    {
      "analysis": "Your narrative analysis here...",
        "personalityTypes": {
        "mbti": "INTJ",
          "enneagram": "Type 3",
            "disc": "D-Style",
              "temperament": "Choleric",
                "bigFive": "High Conscientiousness"
      },
      "traits": {
        "openness": 85,
          "conscientiousness": 90,
            "extraversion": 60,
              "agreeableness": 75,
                "neuroticism": 40
      },
      "roadmap": [
        { "step_title": "...", "step_description": "...", "image_prompt": "..." }
      ]
    }
    `;

  try {
    const result = await model.generateContent(prompt);
    const response = await result.response;
    const text = response.text();

    // Clean up the response to ensure it's valid JSON
    const jsonString = text.replace(/```json / g, '').replace(/```/g, '').trim();
    const parsedData = JSON.parse(jsonString);

    // Enhance roadmap with AI-generated images via Pollinations.ai
    parsedData.roadmap = parsedData.roadmap.map(step => {
      // Create a URL-safe prompt for Pollinations
      const encodedPrompt = encodeURIComponent(step.image_prompt + " realistic, cinematic, 4k, high quality");
      return {
        ...step,
        imageUrl: `https://image.pollinations.ai/prompt/${encodedPrompt}?width=800&height=600&nologo=true`
      };
    });

    return parsedData;
  } catch (error) {
    console.error("AI Generation Error:", error);
    throw new Error("Failed to generate analysis. Please try again.");
  }
  */
};

module.exports = { getAnalysisAndRoadmap };
